<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Department Performance Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f4f4f4;
        }
        h2 {
            text-align: center;
        }
        select {
            padding: 10px;
            font-size: 16px;
            margin-bottom: 20px;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        .card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <h2>Department Monthly Report</h2>

    <center>
        <select id="departmentSelect">
            <option value="">Select Department</option>
        </select>
    </center>

    <div id="dashboard-content" class="dashboard hidden">
        <div class="card"><canvas id="shiftsClinicsChart"></canvas></div>
        <div class="card"><canvas id="salaryIncomeChart"></canvas></div>
        <div class="card"><canvas id="operationsChart"></canvas></div>
        <div class="card"><canvas id="complexityChart"></canvas></div>
    </div>

    <script>
        ////////////////////////////////////////////////////////////////////////////
        // ⚡ CSV LOADING
        ////////////////////////////////////////////////////////////////////////////

        const BASE_URL = "https://raw.githubusercontent.com/AbdullahelBaraka/monthly_report/master/";

        async function loadCSV(url) {
            const res = await fetch(url);
            const text = await res.text();
            // ✅ Changed from comma to tab delimiter
            const rows = text.trim().split("\n").map(r => r.split("\t"));
            const headers = rows.shift();
            return rows.map(row => {
                const obj = {};
                row.forEach((val, idx) => obj[headers[idx]] = val.trim());
                return obj;
            });
        }

        let STAFF = [];
        let PROCEDURES = [];
        let DEPARTMENTS = [];

        async function loadAllCSVs() {
            STAFF = await loadCSV(BASE_URL + "staff.csv");
            PROCEDURES = await loadCSV(BASE_URL + "procedures.csv");

            DEPARTMENTS = [...new Set(STAFF.map(s => s.department))];
            populateDepartmentSelect(DEPARTMENTS);
        }

        ////////////////////////////////////////////////////////////////////////////
        // ⚡ BUILD STAFF DATA OBJECT
        ////////////////////////////////////////////////////////////////////////////

        function buildDepartmentData(departmentName) {
            const staffList = STAFF.filter(s => s.department === departmentName);

            return staffList.map(staff => {
                const staffProcedures = PROCEDURES.filter(p => p.staff_id === staff.staff_id);

                const detailed = {};
                staffProcedures.forEach(p => {
                    if (!detailed[p.procedure_name]) detailed[p.procedure_name] = 0;
                    detailed[p.procedure_name]++;
                });

                return {
                    id: staff.staff_id,
                    name: staff.name,
                    shifts: Number(staff.shifts),
                    clinics: Number(staff.clinics),
                    salary: Number(staff.salary),
                    income: Number(staff.income),
                    operations: {
                        total: Number(staff.total_ops),
                        high: Number(staff.high),
                        moderate: Number(staff.moderate),
                        low: Number(staff.low),
                        detailed: detailed
                    }
                };
            });
        }

        ////////////////////////////////////////////////////////////////////////////
        // ⚡ POPULATE DEPARTMENT DROPDOWN
        ////////////////////////////////////////////////////////////////////////////

        function populateDepartmentSelect(list) {
            const select = document.getElementById("departmentSelect");

            list.forEach(dep => {
                const option = document.createElement("option");
                option.value = dep;
                option.textContent = dep;
                select.appendChild(option);
            });

            select.addEventListener("change", () => {
                const department = select.value;
                if (department) fetchDataAndRender(department);
            });
        }

        ////////////////////////////////////////////////////////////////////////////
        // ⚡ RENDER MAIN DASHBOARD
        ////////////////////////////////////////////////////////////////////////////

        let chartInstances = {};

        function renderDashboard(staffData) {
            document.getElementById("dashboard-content").classList.remove("hidden");

            const names = staffData.map(s => s.name);

            destroyCharts();

            createBarChart("shiftsClinicsChart", names,
                staffData.map(s => s.shifts),
                staffData.map(s => s.clinics),
                "Shifts", "Clinics");

            createBarChart("salaryIncomeChart", names,
                staffData.map(s => s.salary),
                staffData.map(s => s.income),
                "Salary", "Income");

            createStackedBarChart("operationsChart", names, {
                High: staffData.map(s => s.operations.high),
                Moderate: staffData.map(s => s.operations.moderate),
                Low: staffData.map(s => s.operations.low)
            });

            createPieChart("complexityChart", {
                High: staffData.reduce((a, b) => a + b.operations.high, 0),
                Moderate: staffData.reduce((a, b) => a + b.operations.moderate, 0),
                Low: staffData.reduce((a, b) => a + b.operations.low, 0)
            });
        }

        ////////////////////////////////////////////////////////////////////////////
        // ⚡ FETCH DATA
        ////////////////////////////////////////////////////////////////////////////

        function fetchDataAndRender(departmentName) {
            const staffData = buildDepartmentData(departmentName);
            renderDashboard(staffData);
        }

        ////////////////////////////////////////////////////////////////////////////
        // ⚡ CHART HELPERS
        ////////////////////////////////////////////////////////////////////////////

        function destroyCharts() {
            for (const key in chartInstances) chartInstances[key].destroy();
        }

        function createBarChart(id, labels, data1, data2, lbl1, lbl2) {
            const ctx = document.getElementById(id).getContext("2d");
            chartInstances[id] = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [
                        { label: lbl1, data: data1, backgroundColor: "#4e79a7" },
                        { label: lbl2, data: data2, backgroundColor: "#f28e2c" }
                    ]
                }
            });
        }

        function createStackedBarChart(id, labels, datasets) {
            const ctx = document.getElementById(id).getContext("2d");

            chartInstances[id] = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: Object.keys(datasets).map((key, idx) => ({
                        label: key,
                        data: datasets[key],
                        backgroundColor: ["#d62728", "#ffbf00", "#59a14f"][idx]
                    }))
                },
                options: { scales: { x: { stacked: true }, y: { stacked: true } } }
            });
        }

        function createPieChart(id, dataObj) {
            const ctx = document.getElementById(id).getContext("2d");
            chartInstances[id] = new Chart(ctx, {
                type: "pie",
                data: {
                    labels: Object.keys(dataObj),
                    datasets: [{
                        data: Object.values(dataObj),
                        backgroundColor: ["#d62728", "#ffbf00", "#59a14f"]
                    }]
                }
            });
        }

        ////////////////////////////////////////////////////////////////////////////
        // ⚡ INIT
        ////////////////////////////////////////////////////////////////////////////

        loadAllCSVs();
    </script>

</body>
</html>
